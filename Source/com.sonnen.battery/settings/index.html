<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
</head>

<body>
    <header class="homey-header">
        <h1 class="homey-title" data-i18n="settings.title">
        </h1>
        <p class="homey-subtitle" data-i18n="settings.subtitle">
        </p>
    </header>

    <fieldset class="homey-form-fieldset">
        <div class="homey-form-group">
            <label class="homey-form-label" for="inputBatteryAuthToken" data-i18n="settings.authToken">Auth
                Token</label>
            <input class="homey-form-input" id="inputBatteryAuthToken" type="text" value=""
                placeholder="Enter Auth token" />
            <small class="text-muted" data-i18n="settings.authTokenHint">Auth Token is retrieved from user-login on your
                Sonnen Batterie system.</small>
        </div>
        <div class="homey-form-group">
            <label class="homey-form-label" for="inputPullIntervalValue" data-i18n="settings.frequency">Pull data
                interval</label>
            <input class="homey-form-input" id="inputPullIntervalValue" type="number" value=""
                placeholder="Pull frequency in seconds" />
            <small class="text-muted" data-i18n="settings.frequencyHint">Frequency in seconds. How often to pull for
                data. Default is 30 seconds (30).</small>
        </div>
        <hr />
        <div class="homey-form-group">
            <strong data-i18n="settings.remark">Remark</strong> <span data-i18n="settings.note">Please restart the app,
                after changing settings.</span>
        </div>
    </fieldset>
    <button id="save" class="homey-button-primary-full" data-i18n="settings.save">Save changes</button>

    <fieldset class="homey-form-fieldset">
        <div class="homey-form-group">
            <label class="homey-form-label" for="inputDeviceStateValue" data-i18n="settings.deviceState">Device State
                (JSON)</label>
            <textarea class="homey-form-input" id="textAreaDeviceStateValue" placeholder="Device State" rows="10"
                cols="60" disabled="true">
            </textarea>
        </div>
    </fieldset>
    <button id="saveDeviceState" class="homey-button-secondary-full" data-i18n="settings.saveDeviceState">Save Device
        State</button>

    <script type="text/javascript">
        function onHomeyReady(Homey) {
            Homey.ready();

            const inputBatteryAuthTokenElement = document.getElementById("inputBatteryAuthToken");
            const inputPullIntervalValueElement = document.getElementById("inputPullIntervalValue");
            const textAreaDeviceStateValueElement = document.getElementById("textAreaDeviceStateValue");
            const saveElement = document.getElementById("save");
            const saveDeviceStateElement = document.getElementById("saveDeviceState");

            Homey.get("BatteryAuthToken", function (err, authToken) {
                if (err) { return Homey.alert(err); }
                inputBatteryAuthTokenElement.value = authToken;
            });

            Homey.get("BatteryPullInterval", function (err, pullInterval) {
                if (err) { return Homey.alert(err); }
                inputPullIntervalValueElement.value = pullInterval ?? "30";
            });

            Homey.get("deviceState", function (err, deviceState) {
                if (err) { return Homey.alert(err); }
                textAreaDeviceStateValueElement.value = JSON.stringify(deviceState, null, 2) ?? "{}";
            });

            saveElement.addEventListener("click", function (e) {
                let anySaveErrors = false;

                Homey.set("BatteryAuthToken", inputBatteryAuthTokenElement.value, function (err) {
                    if (err) {
                        anySaveErrors = true;
                        return Homey.alert(err);
                    }
                });

                Homey.set("BatteryPullInterval", inputPullIntervalValueElement.value, function (err) {
                    if (err) {
                        anySaveErrors = true;
                        return Homey.alert(err);
                    }
                });

                if (!anySaveErrors) {
                    return Homey.alert(Homey.__("settings.savedOk"));
                } else {
                    return Homey.alert(Homey.__("settings.savedError"));
                }
            });

            saveDeviceStateElement.addEventListener("click", function (e) {
                Homey.api('POST', '/save-device-state')
                    .then((response) => {
                        if (response['saved']) {
                            Homey.alert(Homey.__("settings.deviceStateSaved", { lastUpdate: response['lastUpdate'] }));

                            Homey.get("deviceState", function (err, deviceState) {
                                if (err) { return Homey.alert(err); }
                                textAreaDeviceStateValueElement.value = JSON.stringify(deviceState, null, 2) ?? "{}";
                            });
                        } else {
                            Homey.alert(Homey.__("settings.deviceStateNotSaved"));
                        }
                    })
                    .catch((error) => {
                        Homey.alert(Homey.__("settings.deviceStateNotSaved") + " (" + error.message + ")");
                    });
            });

        }
    </script>
</body>

</html>