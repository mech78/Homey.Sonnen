<html>

<head>
  <style>
    /* Example of a custom CSS class. */
    .custom-image-class {
      margin: var(--homey-su-3) auto var(--homey-su-5);
      --homey-icon-color: var(--homey-icon-color-green);
      --homey-icon-size: var(--homey-icon-size-small);
    }

    .app-container {
      display: flex;
      justify-content: space-between;
      /* Space between the two items */
      flex-wrap: wrap;
      /* Allows items to wrap to the next line */
    }

    .app-item-container {
      margin: 0px 0px;
      
      flex: 1 1 24%;
      /* Each item takes 25% of the width (adjust as needed) */
      max-width: 24%;
      box-sizing: border-box;
      display: flex;
      visibility: hidden;
      flex-direction: column;
      /* Ensures elements inside stack vertically */
      align-items: center;
      /* Center items horizontally within the container */
      text-align: center;
      /* Ensures text aligns in the center */
    }

    .app-icon {
      height: var(--homey-icon-size-medium);
      /* background-color: var(--homey-color-mono-400); */
      /* padding: 16px, 16px, 16px, 16px; */
      padding-bottom: var(--homey-su);
      /* color: var(--homey-color-mono-800) !important; */
    }

    .batteryContainer {
      display: -webkit-box;
      display: -moz-box;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: flex;
      visibility: hidden;
      flex-direction: row;
      align-items: center;
    }

    .batteryOuter {
      border-radius: 3px;
      border: 1px solid var(--homey-color-mono-1000);
      padding: 1px;
      width: 100px;
      height: 35px;
    }

    .batteryBump {
      border-radius: 2px;
      background-color: var(--homey-color-mono-1000);
      margin: 2px;
      width: 1px;
      height: 3px;
    }

    #batteryLevel {
      border-radius: 2px;
      background-color: var(--homey-color-green-500);
      width: 0px;
      height: 31px;
    }

    .homey-custom-icon-panel {
      --homey-icon-color: var(--homey-icon-color-dark);
      padding-bottom: var(--homey-su);
      width: 36px;
      height: 36px;
      -webkit-mask-image: url('solar-battery-4-svgrepo-com.svg');
      mask-image: url('solar-battery-4-svgrepo-com.svg');
    } 

    .homey-custom-icon-house {
      --homey-icon-color: var(--homey-icon-color-dark);
      
      padding-bottom: var(--homey-su);
      width: 36px;
      height: 36px;
      -webkit-mask-image: url('electricity-home-svgrepo-com.svg');
      mask-image: url('electricity-home-svgrepo-com.svg');
    } 

    .homey-custom-icon-pole {
      --homey-icon-color: var(--homey-icon-color-dark);
      padding-bottom: var(--homey-su);
      width: 36px;
      height: 36px;
      -webkit-mask-image: url('electric-tower-power-line-svgrepo-com.svg');
      mask-image: url('electric-tower-power-line-svgrepo-com.svg');
    } 
    
    .sonnen-icon {
      width: 36px;
      height: 36px;
    }

  </style>
</head>

<body class="homey-widget-small">
  <!-- <img src="homey-logo.png" alt="Homey logo" class="custom-image-class" /> -->
  <!-- <p class="homey-text-regular homey-text-align-center">Edit public/index.html and hit refresh.</p> -->

  <div class="app-container">
    <!-- Column 1-->
    <div class="app-item-container" id="solarpanel">
      <div class="homey-custom-icon-panel"></div>
      <p class="homey-text-small-light homey-text-align-center" data-i18n="widget.production">Production</p>
      <p class="homey-text-bold homey-text-align-center"><span id="lblProduction">0</span> W</p>
    </div>
    <!-- Column 2-->
    <div class="app-item-container" id="household">
      <div class="homey-custom-icon-house"></div>
      <p class="homey-text-small-light homey-text-align-center" data-i18n="widget.consumption">Consumption</p>
      <p class="homey-text-bold homey-text-align-center"><span id="lblConsumption">0</span> W</p>
    </div>
    <!-- Column 3-->
    <div class="app-item-container" id="battery">
      <img src="icon.svg" class="app-icon sonnen-icon"></img>
      <p class="homey-text-small-light homey-text-align-center" data-i18n="widget.fromBattery">Battery</p>
      <p class="homey-text-bold homey-text-align-center"><span id="lblBattery">0</span> W</p>
    </div>
    <!-- Column 4-->
    <div class="app-item-container" id="grid">
      <div class="homey-custom-icon-pole"></div>
      <p class="homey-text-small-light homey-text-align-center" data-i18n="widget.fromGrid">Grid</p>
      <p class="homey-text-bold homey-text-align-center"><span id="lblGrid">0</span> W</p>
    </div>
  </div>

  <div>
    <div class="batteryContainer" id="batteryContainer" style="padding-left: var(--homey-su-2);">
      <div class="batteryOuter">
        <div id="batteryLevel"></div>
      </div>
      <div class="batteryBump"></div>
      <span class="homey-font-size-default homey-font-weight-regular" id="batteryPercentage" style="padding-left: var(--homey-su-2);">-%</span>
    </div>
  </div>

  <!--
  <div>
    <span id="lblDebug" style="background-color: green;"></span>
  </div>
  -->

  <script type="text/javascript">

    function onHomeyReady(Homey) {
      Homey.ready();
      
      this.applyData();
      // Repeat every 30 sek.
      setTimeout(() => { this.applyData(); }, 30*1000);
      
    }


function applyData() {
      try {
        Homey.api('GET', '/sonnen-batterie-widget-data').then((widgetData) => {
          
          const devices = [
            { id: 'solarpanel', dataKey: 'production', labelId: 'lblProduction' },
            { id: 'household', dataKey: 'consumption', labelId: 'lblConsumption' },
            { id: 'battery', dataKey: 'battery', labelId: 'lblBattery' },
            { id: 'grid', dataKey: 'from_grid', labelId: 'lblGrid' }
          ];

          let orderIndex = 1;
          devices.forEach(device => {
            const container = document.getElementById(device.id);
            if (widgetData[device.dataKey] !== undefined) {
              container.style.order = orderIndex++;
              document.getElementById(device.labelId).innerText = widgetData[device.dataKey];
              container.style.visibility = 'visible';
            } else {
              container.style.order = 999-orderIndex; // reverse order for unavailable devices to keep space when hiding
              document.getElementById(device.labelId).innerText = '-'; // N/A
              container.style.visibility = 'hidden';
            }
          });

          if (widgetData.percentage !== undefined) {
            document.getElementById('batteryLevel').style.width = widgetData.percentage + 'px';
            document.getElementById('batteryPercentage').innerText = widgetData.percentage + '%';
            document.getElementById('batteryContainer').style.visibility = 'visible';
          } else {
            document.getElementById('batteryContainer').style.visibility = 'hidden';
          }

        });
      } catch (e) {}
    
    }

  </script>
</body>

</html>